generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "..svg"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String     @id @default(cuid())
  email       String     @unique
  username    String?    @unique
  firstName   String?
  lastName    String?
  displayName String?
  userType    UserType   @default(CUSTOMER)
  status      UserStatus @default(ACTIVE)
  lastLoginAt DateTime?
  deletedAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  authAccounts         AuthAccount[]
  sessions             Session[]
  roleAssignments      UserRoleAssignment[]
  refreshTokens        RefreshToken[]
  securityEvents       SecurityEvent[]
  mfaChallenges        MfaChallenge[]
  permissionOverrides  UserPermissionOverride[]
  customerProfile      CustomerProfile?
  workerProfile        WorkerProfile?
  businessOwnerProfile BusinessOwnerProfile?
  addresses            UserAddress[]
  mfaFactors           MfaFactor[]
  auditLogs            UserAuditLog[]
  passwordResets       PasswordReset[]
  emailVerifications   EmailVerification[]
  repliedMessages      ContactMessage[]          @relation("LastRepliedBy")
  messageReplies       ContactMessageReply[]
  verifiedCompanies    CompanyVerificationAudit[] @relation("VerifiedBy")
  verifiedDocuments    DocumentVerificationAudit[]

  @@index([email])
  @@index([status])
  @@index([deletedAt])
  @@index([userType])
  @@index([userType, deletedAt])
  @@map("users")
}

enum UserType {
  CUSTOMER
  ADMIN
  WORKER
  BUSINESS_OWNER
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Address {
  id           String    @id @default(cuid())
  addressType  String
  line1        String
  line2        String?
  city         String
  state        String?
  postalCode   String
  country      String
  latitude     Float?
  longitude    Float?
  isDefault    Boolean   @default(false)
  verifiedAt   DateTime?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  userAddresses        UserAddress[]
  customerProfiles     CustomerProfile[]
  businessOwnerProfiles BusinessOwnerProfile[]
  companies            Company[]

  @@index([country])
  @@index([postalCode])
  @@index([deletedAt])
  @@map("addresses")
}

model UserAddress {
  id        String      @id @default(cuid())
  userId    String
  addressId String
  type      AddressType @default(SHIPPING)
  deletedAt DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  address Address @relation(fields: [addressId], references: [id], onDelete: Restrict)

  @@unique([userId, addressId, type])
  @@index([userId, deletedAt])
  @@map("user_addresses")
}

enum AddressType {
  SHIPPING
  BILLING
  HOME
  WORK
}

model AuthAccount {
  id           String       @id @default(cuid())
  userId       String
  provider     AuthProvider
  providerId   String
  passwordHash String?
  isPrimary    Boolean      @default(false)
  verifiedAt   DateTime?
  lastUsedAt   DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([userId])
  @@map("auth_accounts")
}

enum AuthProvider {
  LOCAL
  GOOGLE
  FACEBOOK
  APPLE
}

model Session {
  id            String         @id @default(cuid())
  userId        String
  sessionToken  String         @unique
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?
  expiresAt     DateTime
  revokedAt     DateTime?
  refreshTokens RefreshToken[]
  mfaChallenges MfaChallenge[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([expiresAt])
  @@index([sessionToken])
  @@map("sessions")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_resets")
}

model EmailVerification {
  id         String    @id @default(cuid())
  userId     String
  email      String
  token      String    @unique
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

model CustomerProfile {
  id                    String    @id @default(cuid())
  userId                String    @unique
  phoneEncrypted        String?
  phoneIv               String?
  phoneTag              String?
  phoneVerifiedAt       DateTime?
  birthDateEncrypted    String?
  birthDateIv           String?
  birthDateTag          String?
  primaryAddressId      String?
  preferences           Json?
  loyaltyPoints         Int       @default(0)
  marketingConsent      Boolean   @default(false)
  dataProcessingConsent Boolean   @default(true)
  deletedAt             DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  primaryAddress Address? @relation(fields: [primaryAddressId], references: [id], onDelete: SetNull)

  @@index([deletedAt])
  @@map("customer_profiles")
}

model BusinessOwnerProfile {
  id                       String    @id @default(cuid())
  userId                   String    @unique
  businessName             String
  businessType             String?
  taxIdEncrypted           String?
  taxIdIv                  String?
  taxIdTag                 String?
  primaryAddressId         String?
  businessPhoneEncrypted   String?
  businessPhoneIv          String?
  businessPhoneTag         String?
  businessEmailEncrypted   String?
  businessEmailIv          String?
  businessEmailTag         String?
  verifiedAt               DateTime?
  verifiedBy               String?
  kycStatus                KycStatus @default(PENDING)
  kycCompletedAt           DateTime?
  dataProcessingConsent    Boolean   @default(true)
  deletedAt                DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  primaryAddress Address? @relation(fields: [primaryAddressId], references: [id], onDelete: SetNull)
  companies      Company[]

  @@index([businessType])
  @@index([kycStatus])
  @@index([deletedAt])
  @@map("business_owner_profiles")
}

enum KycStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

model WorkerProfile {
  id           String    @id @default(cuid())
  userId       String    @unique
  position     String?
  department   String?
  employeeId   String?
  hiredAt      DateTime  @default(now())
  terminatedAt DateTime?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([terminatedAt])
  @@index([deletedAt])
  @@map("worker_profiles")
}

model Company {
  id                           String                        @id @default(cuid())
  ownerId                      String
  name                         String
  slug                         String                        @unique
  legalName                    String
  legalStatus                  CompanyLegalStatus            @default(ACTIVE)
  registrationNumber           String
  taxIdEncrypted               String?
  taxIdIv                      String?
  taxIdTag                     String?
  legalRepresentativeEncrypted String?
  legalRepresentativeIv        String?
  legalRepresentativeTag       String?
  countryOfIncorporation       String
  incorporationDate            DateTime?
  registeredAddressId          String
  businessLicenseUrl           String?
  taxCertificateUrl            String?
  incorporationDocUrl          String?
  otherDocumentsUrls           String[]                      @default([])
  documentVerificationStatus   DocumentVerificationStatus    @default(PENDING)
  description                  String?
  logo                         String?
  website                      String?
  industry                     String?
  status                       CompanyStatus                 @default(PENDING)
  verifiedAt                   DateTime?
  suspendedAt                  DateTime?
  closedAt                     DateTime?
  deletedAt                    DateTime?
  metadata                     Json?
  createdAt                    DateTime                      @default(now())
  updatedAt                    DateTime                      @updatedAt

  owner               BusinessOwnerProfile       @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  registeredAddress   Address                    @relation(fields: [registeredAddressId], references: [id], onDelete: Restrict)
  roleAssignments     UserRoleAssignment[]
  permissionOverrides UserPermissionOverride[]
  verificationAudits  CompanyVerificationAudit[]
  documentAudits      DocumentVerificationAudit[]

  @@unique([registrationNumber, countryOfIncorporation])
  @@index([ownerId])
  @@index([status, deletedAt])
  @@index([slug])
  @@index([registrationNumber])
  @@index([countryOfIncorporation])
  @@index([legalStatus])
  @@index([documentVerificationStatus])
  @@map("companies")
}

enum CompanyStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CLOSED
}

enum CompanyLegalStatus {
  ACTIVE
  DISSOLVED
  LIQUIDATION
  BANKRUPTCY
  SUSPENDED
}

enum DocumentVerificationStatus {
  PENDING
  IN_REVIEW
  VERIFIED
  REJECTED
  EXPIRED
}

model CompanyVerificationAudit {
  id             String        @id @default(cuid())
  companyId      String
  verifiedById   String
  previousStatus CompanyStatus
  newStatus      CompanyStatus
  notes          String?
  documentsChecked String[]    @default([])
  ipAddress      String?
  createdAt      DateTime      @default(now())

  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  verifiedBy User    @relation("VerifiedBy", fields: [verifiedById], references: [id], onDelete: Restrict)

  @@index([companyId])
  @@index([verifiedById])
  @@index([createdAt])
  @@map("company_verification_audits")
}

model DocumentVerificationAudit {
  id                  String                     @id @default(cuid())
  companyId           String
  verifiedById        String
  documentType        String
  documentUrl         String
  previousStatus      DocumentVerificationStatus
  newStatus           DocumentVerificationStatus
  rejectionReason     String?
  expiryDate          DateTime?
  notes               String?
  ipAddress           String?
  createdAt           DateTime                   @default(now())

  company    Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  verifiedBy User    @relation(fields: [verifiedById], references: [id], onDelete: Restrict)

  @@index([companyId])
  @@index([verifiedById])
  @@index([documentType])
  @@index([createdAt])
  @@map("document_verification_audits")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  userType    UserType?
  isSystem    Boolean  @default(true)
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]
  users       UserRoleAssignment[]

  @@index([isSystem, isActive])
  @@index([userType])
  @@map("roles")
}

model Permission {
  id            String                   @id @default(cuid())
  resource      String
  action        String
  description   String?
  userOverrides UserPermissionOverride[]
  createdAt     DateTime                 @default(now())

  roles RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  companyId  String?
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  revokedAt  DateTime?

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, companyId])
  @@index([userId, revokedAt])
  @@index([roleId])
  @@index([companyId])
  @@index([expiresAt])
  @@map("user_role_assignments")
}

model GuestCheckout {
  id              String    @id @default(cuid())
  email           String
  sessionToken    String    @unique
  firstName       String?
  lastName        String?
  phone           String?
  shippingAddress Json?
  billingAddress  Json?
  checkoutData    Json
  orderIds        String[]  @default([])
  expiresAt       DateTime
  convertedUserId String?   @unique
  convertedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
  @@index([expiresAt])
  @@index([convertedUserId])
  @@index([sessionToken])
  @@map("guest_checkouts")
}

model MfaFactor {
  id           String    @id @default(cuid())
  userId       String
  type         MfaType
  secretCipher String
  secretIv     String
  secretTag    String
  verifiedAt   DateTime?
  lastUsedAt   DateTime?
  revokedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@map("mfa_factors")
}

enum MfaType {
  TOTP
  SMS
  EMAIL
  WEBAUTHN
}

model UserAuditLog {
  id           String   @id @default(cuid())
  userId       String
  action       String
  resource     String?
  resourceId   String?
  success      Boolean
  errorMessage String?
  ipAddress    String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@map("user_audit_logs")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  readAt    DateTime?
  deletedAt DateTime?
  createdAt DateTime         @default(now())

  @@index([userId, readAt])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM
  SECURITY
  ACCOUNT
  COMPANY
  ALERT
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  sessionId String
  token     String    @unique
  familyId  String
  ipAddress String?
  userAgent String?
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([userId, revokedAt])
  @@index([expiresAt])
  @@index([familyId])
  @@map("refresh_tokens")
}

model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("token_blacklist")
}

model SecurityEvent {
  id          String   @id @default(cuid())
  userId      String?
  email       String?
  eventType   String
  severity    String
  description String
  ipAddress   String?
  userAgent   String?
  blocked     Boolean  @default(false)
  actionTaken String?
  metadata    Json?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([eventType])
  @@index([createdAt])
  @@map("security_events")
}

model MfaChallenge {
  id         String             @id @default(cuid())
  userId     String
  sessionId  String
  factorType MfaType
  reason     MfaChallengeReason
  satisfied  Boolean            @default(false)
  expiresAt  DateTime
  createdAt  DateTime           @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, factorType])
  @@index([userId])
  @@index([expiresAt])
  @@map("mfa_challenges")
}

enum MfaChallengeReason {
  LOGIN
  SENSITIVE_ACTION
}

model UserPermissionOverride {
  id           String    @id @default(cuid())
  userId       String
  permissionId String
  companyId    String?
  isGranted    Boolean
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  company    Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, companyId])
  @@index([expiresAt])
  @@map("user_permission_overrides")
}

model NewsletterSubscription {
  id             String    @id @default(uuid())
  email          String    @unique
  active         Boolean   @default(true)
  unsubscribedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("newsletter_subscriptions")
}

model ContactMessage {
  id              String        @id @default(cuid())
  name            String
  email           String
  phone           String?
  subject         String?
  message         String
  status          MessageStatus @default(NEW)
  repliedAt       DateTime?
  lastRepliedById String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  readAt          DateTime?

  lastRepliedBy User?                 @relation("LastRepliedBy", fields: [lastRepliedById], references: [id])
  replies       ContactMessageReply[]

  @@index([email])
  @@index([status])
  @@index([repliedAt])
  @@map("contact_messages")
}

model ContactMessageReply {
  id               String         @id @default(cuid())
  contactMessageId String
  authorId         String
  content          String
  sentVia          ReplyChannel   @default(EMAIL)
  deliveryStatus   DeliveryStatus @default(SENT)
  sentAt           DateTime       @default(now())
  createdAt        DateTime       @default(now())

  contactMessage ContactMessage @relation(fields: [contactMessageId], references: [id], onDelete: Cascade)
  author         User           @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([contactMessageId])
  @@index([authorId])
  @@index([sentAt])
  @@map("contact_message_replies")
}

enum MessageStatus {
  NEW
  READ
  REPLIED
  ARCHIVED
  SPAM
}

enum ReplyChannel {
  EMAIL
  DASHBOARD
}

enum DeliveryStatus {
  SENT
  FAILED
  QUEUED
}

model RateLimit {
  id           String    @id @default(cuid())
  identifier   String
  action       String
  windowStart  DateTime
  expiresAt    DateTime
  count        Int       @default(0)
  blockedUntil DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([identifier, action, windowStart], name: "identifier_action_windowStart")
  @@index([identifier])
  @@index([expiresAt])
  @@index([blockedUntil])
  @@map("rate_limits")
}
